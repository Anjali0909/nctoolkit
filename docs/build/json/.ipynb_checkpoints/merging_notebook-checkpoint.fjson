{
    "body": "<div class=\"section\" id=\"Ensemble-methods\">\n<h1>Ensemble methods<a class=\"headerlink\" href=\"#Ensemble-methods\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<div class=\"section\" id=\"Merging-files-with-different-variables\">\n<h2>Merging files with different variables<a class=\"headerlink\" href=\"#Merging-files-with-different-variables\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<p>This notebook will outline some general methods for doing comparisons of multiple files. We will work with two different sea surface temperature data sets from NOAA and the Met Office Hadley Centre.</p>\n<div class=\"nbinput docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[1]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">nchack</span> <span class=\"k\">as</span> <span class=\"nn\">nc</span>\n<span class=\"kn\">import</span> <span class=\"nn\">pandas</span> <span class=\"k\">as</span> <span class=\"nn\">pd</span>\n<span class=\"kn\">import</span> <span class=\"nn\">xarray</span> <span class=\"k\">as</span> <span class=\"nn\">xr</span>\n<span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n</pre></div>\n</div>\n</div>\n<div class=\"nboutput nblast docutils container\">\n<div class=\"prompt empty docutils container\">\n</div>\n<div class=\"output_area docutils container\">\n<div class=\"highlight\"><pre>\nTip: include atexit.register(nchack.clean_all) after loading nchack\n</pre></div></div>\n</div>\n<p>The first step is to get the data. We will start by creating two separate trackers for each file.</p>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[2]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">tracker1</span> <span class=\"o\">=</span> <span class=\"n\">nc</span><span class=\"o\">.</span><span class=\"n\">open_data</span><span class=\"p\">(</span><span class=\"s2\">&quot;/users/modellers/rwi/nchack/data/ensemble_merge/sst.mon.mean.nc&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">tracker2</span> <span class=\"o\">=</span> <span class=\"n\">nc</span><span class=\"o\">.</span><span class=\"n\">open_data</span><span class=\"p\">(</span><span class=\"s2\">&quot;/users/modellers/rwi/nchack/data/ensemble_merge/HadISST_sst.nc&quot;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n</div>\n<p>We can see that both variables have sea surface temperature labelled as sst. So we will need to change that.</p>\n<div class=\"nbinput docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[3]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">tracker1</span><span class=\"o\">.</span><span class=\"n\">variables</span>\n<span class=\"n\">tracker2</span><span class=\"o\">.</span><span class=\"n\">variables</span>\n</pre></div>\n</div>\n</div>\n<div class=\"nboutput docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[3]:\n</pre></div>\n</div>\n<div class=\"output_area highlight-none notranslate\"><div class=\"highlight\"><pre>\n<span></span>[&#39;sst&#39;]\n</pre></div>\n</div>\n</div>\n<div class=\"nboutput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[3]:\n</pre></div>\n</div>\n<div class=\"output_area highlight-none notranslate\"><div class=\"highlight\"><pre>\n<span></span>[&#39;time_bnds&#39;, &#39;sst&#39;]\n</pre></div>\n</div>\n</div>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[4]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">tracker1</span><span class=\"o\">.</span><span class=\"n\">rename</span><span class=\"p\">({</span><span class=\"s2\">&quot;sst&quot;</span><span class=\"p\">:</span><span class=\"s2\">&quot;noaa&quot;</span><span class=\"p\">})</span>\n<span class=\"n\">tracker2</span><span class=\"o\">.</span><span class=\"n\">rename</span><span class=\"p\">({</span><span class=\"s2\">&quot;sst&quot;</span><span class=\"p\">:</span><span class=\"s2\">&quot;hadley&quot;</span><span class=\"p\">})</span>\n</pre></div>\n</div>\n</div>\n<p>The data sets also cover different time periods, and only have overlapping between 1870 and 2018. so we will need to select those years</p>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[5]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">tracker1</span><span class=\"o\">.</span><span class=\"n\">select_years</span><span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">1870</span><span class=\"p\">,</span> <span class=\"mi\">2019</span><span class=\"p\">)))</span>\n<span class=\"n\">tracker2</span><span class=\"o\">.</span><span class=\"n\">select_years</span><span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">1870</span><span class=\"p\">,</span> <span class=\"mi\">2019</span><span class=\"p\">)))</span>\n</pre></div>\n</div>\n</div>\n<p>We also have a problem in that there are two horizontal grids in the Hadley Centre file. We can solve this by selecting the sst variable only</p>\n<div class=\"nbinput docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[6]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">tracker2</span><span class=\"o\">.</span><span class=\"n\">numbers</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n</div>\n<div class=\"nboutput nblast docutils container\">\n<div class=\"prompt empty docutils container\">\n</div>\n<div class=\"output_area docutils container\">\n<div class=\"highlight\"><pre>\nNumber of variables: 2\nNumber of levels: 1\nNumber of years: 149\nNumber of months: 1788\nNumber of dates: 1788\nNumber of times: 1788\nNumber of grid points: 2\nNumber of horizontal grids: 2\n</pre></div></div>\n</div>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[7]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">tracker2</span><span class=\"o\">.</span><span class=\"n\">select_variables</span><span class=\"p\">(</span><span class=\"s2\">&quot;hadley&quot;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n</div>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[ ]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span>\n</pre></div>\n</div>\n</div>\n<p>At this point, the trackers have the same number of time steps and months covered. However, the grids are still a bit different. So we want to unify them by regridding one tracker on to the other\u2019s grid. This can be done using regrid, or any grid of your choosing.</p>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[8]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">tracker1</span><span class=\"o\">.</span><span class=\"n\">regrid</span><span class=\"p\">(</span><span class=\"n\">grid</span> <span class=\"o\">=</span> <span class=\"n\">tracker2</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n</div>\n<p>We now have two separate trackers. Let\u2019s create a new tracker that has both of them, and then merge them. When doing this we need to make sure nas are treated properly. In this case Hadley Centre values not being NAs as they should be, so we need to fix that.</p>\n<div class=\"nbinput docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[9]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">big_tracker</span> <span class=\"o\">=</span> <span class=\"n\">nc</span><span class=\"o\">.</span><span class=\"n\">merge</span><span class=\"p\">(</span><span class=\"n\">tracker1</span><span class=\"p\">,</span> <span class=\"n\">tracker2</span><span class=\"p\">)</span>\n<span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">set_missing</span><span class=\"p\">([</span><span class=\"o\">-</span><span class=\"mi\">9000</span><span class=\"p\">,</span> <span class=\"o\">-</span> <span class=\"mi\">900</span><span class=\"p\">])</span>\n</pre></div>\n</div>\n</div>\n<div class=\"nboutput nblast docutils container\">\n<div class=\"prompt empty docutils container\">\n</div>\n<div class=\"output_area docutils container\">\n<div class=\"highlight\"><pre>\n<span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">AttributeError</span>                            Traceback (most recent call last)\n<span class=\"ansi-green-fg\">&lt;ipython-input-9-c8afc4ff02c6&gt;</span> in <span class=\"ansi-cyan-fg\">&lt;module&gt;</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span><span class=\"ansi-red-fg\"> </span>big_tracker <span class=\"ansi-blue-fg\">=</span> nc<span class=\"ansi-blue-fg\">.</span>merge_trackers<span class=\"ansi-blue-fg\">(</span>tracker1<span class=\"ansi-blue-fg\">,</span> tracker2<span class=\"ansi-blue-fg\">)</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">      2</span> big_tracker<span class=\"ansi-blue-fg\">.</span>set_missing<span class=\"ansi-blue-fg\">(</span><span class=\"ansi-blue-fg\">[</span><span class=\"ansi-blue-fg\">-</span><span class=\"ansi-cyan-fg\">9000</span><span class=\"ansi-blue-fg\">,</span> <span class=\"ansi-blue-fg\">-</span> <span class=\"ansi-cyan-fg\">900</span><span class=\"ansi-blue-fg\">]</span><span class=\"ansi-blue-fg\">)</span>\n\n<span class=\"ansi-red-fg\">AttributeError</span>: module &#39;nchack&#39; has no attribute &#39;merge_trackers&#39;\n</pre></div></div>\n</div>\n<p>Let\u2019s work out what the global mean SST was over the time period. Note that this will not be totally accurate as there are some missing values here and there that might bias things.</p>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[ ]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">spatial_mean</span><span class=\"p\">()</span>\n<span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">annual_mean</span><span class=\"p\">()</span>\n<span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">rolling_mean</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n</div>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[ ]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">to_xarray</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">hadley</span><span class=\"o\">.</span><span class=\"n\">plot</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n</div>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[ ]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">to_xarray</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">noaa</span><span class=\"o\">.</span><span class=\"n\">plot</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n</div>\n<p>We can also work out the difference between the two. Here we wil work out the monthly bias per cell. Then calculate the mean global difference per year, and then calculate a rolling 10 year mean.</p>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[ ]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">big_tracker</span> <span class=\"o\">=</span> <span class=\"n\">nc</span><span class=\"o\">.</span><span class=\"n\">open_data</span><span class=\"p\">([</span><span class=\"n\">tracker1</span><span class=\"o\">.</span><span class=\"n\">current</span><span class=\"p\">,</span> <span class=\"n\">tracker2</span><span class=\"o\">.</span><span class=\"n\">current</span><span class=\"p\">])</span>\n<span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">merge</span><span class=\"p\">()</span>\n<span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">mutate</span><span class=\"p\">({</span><span class=\"s2\">&quot;bias&quot;</span><span class=\"p\">:</span><span class=\"s2\">&quot;hadley-noaa&quot;</span><span class=\"p\">})</span>\n<span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">set_missing</span><span class=\"p\">([</span><span class=\"o\">-</span><span class=\"mi\">9000</span><span class=\"p\">,</span> <span class=\"o\">-</span> <span class=\"mi\">900</span><span class=\"p\">])</span>\n<span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">spatial_mean</span><span class=\"p\">()</span>\n<span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">annual_mean</span><span class=\"p\">()</span>\n<span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">rolling_mean</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">)</span>\n<span class=\"n\">big_tracker</span><span class=\"o\">.</span><span class=\"n\">to_xarray</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">bias</span><span class=\"o\">.</span><span class=\"n\">plot</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n</div>\n<p>You can see that there is a notable difference at the start of the time series.</p>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[ ]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">new</span> <span class=\"o\">=</span> <span class=\"n\">nc</span><span class=\"o\">.</span><span class=\"n\">open_data</span><span class=\"p\">(</span><span class=\"n\">tracker1</span><span class=\"o\">.</span><span class=\"n\">current</span><span class=\"p\">)</span>\n<span class=\"n\">new</span><span class=\"o\">.</span><span class=\"n\">spatial_mean</span><span class=\"p\">()</span>\n<span class=\"n\">new</span><span class=\"o\">.</span><span class=\"n\">annual_mean</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n</div>\n</div>\n<div class=\"section\" id=\"Merging-files-with-different-times\">\n<h2>Merging files with different times<a class=\"headerlink\" href=\"#Merging-files-with-different-times\" title=\"Permalink to this headline\">\u00b6</a></h2>\n</div>\n<div class=\"section\" id=\"Ensemble-averaging\">\n<h2>Ensemble averaging<a class=\"headerlink\" href=\"#Ensemble-averaging\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<div class=\"nbinput nblast docutils container\">\n<div class=\"prompt highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>[ ]:\n</pre></div>\n</div>\n<div class=\"input_area highlight-ipython3 notranslate\"><div class=\"highlight\"><pre>\n<span></span>\n</pre></div>\n</div>\n</div>\n</div>\n</div>\n",
    "title": "Ensemble methods",
    "sourcename": ".ipynb_checkpoints/merging_notebook-checkpoint.ipynb.txt",
    "current_page_name": ".ipynb_checkpoints/merging_notebook-checkpoint",
    "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Ensemble methods</a><ul>\n<li><a class=\"reference internal\" href=\"#Merging-files-with-different-variables\">Merging files with different variables</a></li>\n<li><a class=\"reference internal\" href=\"#Merging-files-with-different-times\">Merging files with different times</a></li>\n<li><a class=\"reference internal\" href=\"#Ensemble-averaging\">Ensemble averaging</a></li>\n</ul>\n</li>\n</ul>\n",
    "page_source_suffix": ".ipynb"
}